name: ðŸ”¥ Destroy All Resources (Stop Billing)

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  destroy-infrastructure:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Remove Conflicting Resources from State
        run: |
          # Remove resources causing conflicts from state
          terraform state rm 'module.eks.module.kms.aws_kms_alias.this["cluster"]' || true
          terraform state rm 'module.eks.aws_cloudwatch_log_group.this[0]' || true
        working-directory: ./terraform
        continue-on-error: true

      - name: Delete Conflicting AWS Resources Manually
        run: |
          # Delete the resources that already exist
          aws kms delete-alias --alias-name alias/eks/pre-cluster --region us-east-1 || true
          aws logs delete-log-group --log-group-name /aws/eks/pre-cluster/cluster --region us-east-1 || true
        continue-on-error: true

      - name: Terraform Destroy
        run: terraform destroy -auto-approve
        working-directory: ./terraform

      - name: Verify Complete Deletion
        run: |
          echo "Verifying all resources deleted..."
          aws eks list-clusters --region us-east-1
          aws ecr describe-repositories --region us-east-1 || echo "âœ… ECR deleted"
