name: üí£ Destroy Everything (Stop Billing)

on:
  workflow_dispatch:  # Manual trigger only - safety measure

jobs:
  destroy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Delete Conflicting Resources First
        run: |
          echo "üóëÔ∏è Deleting KMS alias..."
          aws kms delete-alias --alias-name alias/eks/pre-cluster --region us-east-1 || echo "Already deleted or doesn't exist"
          
          echo "üóëÔ∏è Deleting CloudWatch log group..."
          aws logs delete-log-group --log-group-name /aws/eks/pre-cluster/cluster --region us-east-1 || echo "Already deleted or doesn't exist"
          
          echo "‚úÖ Pre-cleanup complete"

      - name: Delete EKS Cluster (Main Cost Driver)
        run: |
          # Get nodegroup name
          NODEGROUP=$(aws eks list-nodegroups --cluster-name pre-cluster --region us-east-1 --query 'nodegroups[0]' --output text 2>/dev/null || echo "")
          
          if [ ! -z "$NODEGROUP" ] && [ "$NODEGROUP" != "None" ]; then
            echo "üóëÔ∏è Deleting nodegroup: $NODEGROUP"
            aws eks delete-nodegroup --cluster-name pre-cluster --nodegroup-name $NODEGROUP --region us-east-1
            
            echo "‚è≥ Waiting for nodegroup deletion..."
            aws eks wait nodegroup-deleted --cluster-name pre-cluster --nodegroup-name $NODEGROUP --region us-east-1 || echo "Timeout or already deleted"
          fi
          
          echo "üóëÔ∏è Deleting EKS cluster..."
          aws eks delete-cluster --name pre-cluster --region us-east-1 || echo "Cluster already deleted"

      - name: Delete ECR Repository
        run: |
          echo "üóëÔ∏è Deleting ECR repository..."
          aws ecr delete-repository --repository-name memory-leak-app --force --region us-east-1 || echo "Already deleted"

      - name: Verify Deletion Complete
        run: |
          echo "‚úÖ Checking remaining resources..."
          aws eks list-clusters --region us-east-1
          aws ecr describe-repositories --region us-east-1 2>&1 | grep -q "RepositoryNotFoundException" && echo "‚úÖ ECR fully deleted" || echo "‚ö†Ô∏è  Some ECR repos remain"
          echo "üí∞ Billing should now stop!"
